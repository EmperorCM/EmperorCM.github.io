<?phpclass newsAction extends HomeAction {    public function index() {        $n = M('news');        $map['pic']=array('neq',"");        $news=$n->where($map)->limit(0,6)->select();        $this->assign('news', $news);        $this->display();    }        public function listN() {        $map['classid'] = $_GET['id'] ? $_GET['id'] : 0;        $news = $this->getData($map['classid'], 18);        $c = M('class');        $class = $c->select();        foreach ($class as $key => $value) {            if ($class[$key]['classid'] == $map['classid'] && $class[$key]['parentid'] != 0) {                $map['classid'] = $class[$key]['parentid'];                break;            }        }        $this->assign('class', $class);        $this->assign('catg', $map['classid']);        $this->assign('news', $news['news']);        $this->assign('page', $news['page']);        $this->display("list");    }    private function getClass($id) {        $c = M('class');        if ($id) {            $parentid = $c->where('classid=' . $id)->getField('parentid');            $id = $parentid != 0 ? $parentid : $id;        }        $map['parentid'] = $id === 0 || $id != null ? $id : array('neq', 0);        $class = $c->where($map)->select();        return $class;    }    public function page() {        $id = $_GET['id'];        $p = M('pages');        $n = M('news');        $map['id'] = $id;        $p->setInc('hit', 'id=' . $id);        $page = $p->where($map)->find();        $list = $n->field('id,title,pic')->limit('0,11')->order('id desc')->select();   //获取当前分类下文章        if ($page) {            $this->assign('list', $list);            $this->assign('page', $page);            $this->display('page');        }    }    public function p() {        echo "<div style='display:none;'>123123</div>";        $n = M('news');        $c = M('class');        $class = $c->select();        $this->assign('class', $class);        $map['id'] = $_GET['id'];        $field = "nb_news.id,nb_news.classid,nb_news.title,nb_class.title as class,content,hit,nb_news.create_time,user,`from`,intro";        $new = $n->field($field)->where($map)->join("nb_class ON nb_news.classid=nb_class.classid")->find();        if ($new) {            $list = $n->field('id,title,pic')->where('classid=' . $new['classid'] . ' AND id not in (' . $new['id'] . ')')->limit('0,11')->order('id desc')->select();   //获取当前分类下文章            $n->setInc('hit', 'id=' . $_GET['id']); //增加点击数            if ($new['files'] != "" && strpos("a" . $new['files'], "http://") == false)                $new['files'] = C('WEB_URL') . "Uploads/" . $new['files'];            $cm = M("comment");            $comment = $cm->field("comment_id,author,content,create_time,user_face")->where("new_id=" . $_GET['id'] . " and approved=1")->select();            foreach ($class as $key => $value) {                if ($class[$key]['classid'] == $new['classid']) {                    $title = $class[$key]['title']; //分类名称                    $catg = $class[$key]['parentid'] != 0 ? $class[$key]['parentid'] : $class[$key]['classid'];                    break;                }            }            $this->assign('catg', $catg);   //分类ID            $this->assign('title', $title); //分类名称            $this->assign('list', $list);    //保存分类下列表；            $this->assign('comment', $comment);            $this->assign('new', $new);            $this->display('detail');        }    }    public function pList() {        //计算当前分类下的所有新闻        if ($_GET['cid']||$_GET['mid']==0) {            $data = $this->getData($_GET['cid'], site('textListNum'));            $this->assign('cid', $_GET['cid']);   //保存一级分类ID        } else if ($_GET['mid']) {            $data = $this->getDataM($_GET['mid'], site('textListNum'));            $this->assign('mid', $_GET['mid']);   //保存一级模块ID        }        $class=M('module')->field("moduleid,title")->select();        for($i=0;$i<count($class);$i++){            $classArr[$class[$i]['moduleid']]=$class[$i]['title'];        }        $this->assign('class',$classArr);        $this->assign('cid', $_GET['cid']);        $this->assign('news', $data['news']);        $this->assign('title', $data['title']);        $this->assign('page', $data['page']);        $this->display('module');    }    public function comment() {        $data['new_id'] = $_GET['id'];        $data['author'] = $_GET['author'];        $data['author_email'] = $_GET['email'];        $data['content'] = $_GET['content'];        if ($data['author'] == null || $data['author_email'] == null || $data['content'] == null)            $this->ajaxReturn($id, "输入的数据不全！", 0);        $data['author_ip'] = $_SERVER["REMOTE_ADDR"];        $data['create_time'] = time();        $data['approved'] = 1; //审核状态，后期从配置获取        $data['user_face'] = "face_00" . rand(1, 7) . ".png";        $c = M('comment');        $result = $c->add($data);        if ($result) {            $data['create_time'] = date("Y-m-n h:i");            $this->ajaxReturn($data, "留言成功", 1);        }        $this->ajaxReturn($id, "留言失败！请重试", 0);    }    //获取当前分类下所有数据    public function getData($class_id, $listNum) {        $n = M('news');        $c = M("class");        if ($class_id != 0) {            $id = $c->field('classid')->where('parentid=' . $class_id)->select(); //获取当前子分类            for ($i = 0; $i < count($id); $i++) {                $classid[$i] = $id[$i]['classid'];            }            $classid[count($id) + 1] = $class_id;            $map['classid'] = array('in', $classid);        }        import("@.ORG.Page");        $count = $n->where($map)->count();        $p = new Page($count, $listNum);        $data['page'] = $p->show(); //列表分页信息        $field = 'id,title,classid,hit,create_time,user,intro,pic,moduleid';        $data['news'] = $n->field($field)->where($map)->limit($p->firstRow . ',' . $p->listRows)->order('id desc')->select();   //列表信息        $data['title'] = $c->where($map)->getField('title');  //分类名称        return $data;    }    //获取当前模块下所有数据    public function getDataM($module_id, $listNum) {        $n = M('news');        $c = M("module");        $id = $c->field('moduleid')->where('parentid=' . $class_id)->select();        for ($i = 0; $i < count($id); $i++) {            $moduleid[$i] = $id[$i]['moduleid'];        }        $moduleid[count($id) + 1] = $module_id;        $map['moduleid'] = array('in', $moduleid);        import("@.ORG.Page");        $count = $n->where($map)->count();        $p = new Page($count, $listNum);        $data['page'] = $p->show(); //列表分页信息        $field = 'id,title,classid,moduleid,hit,create_time,user,intro,pic';        $data['news'] = $n->field($field)->where($map)->limit($p->firstRow . ',' . $p->listRows)->order('id desc')->select();   //列表信息        $data['title'] = $c->where($map)->getField('title');  //分类名称        return $data;    }}?>